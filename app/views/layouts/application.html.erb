<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%= full_title(yield(:title)) %></title>
    <%= stylesheet_link_tag    'application', media: 'all', 
                                              'data-turbolinks-track' => true %>
    <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
    <%= csrf_meta_tags %>
    <%= render 'layouts/shim' %>

    <!-- Google Fonts go here -->

  </head>
  <body>
    <%= render 'layouts/header' %>
    <div class="container">
      <% flash.each do |message_type, message| %>
        <div class="alert alert-<%= message_type %>"><%= message %></div>
      <% end %>
      <%= yield %>
      <%= render 'layouts/footer' %>
      <%= debug(params) if Rails.env.development? %>
    </div>

    <script>
    $(document).ready(function(){
      <%= yield(:javascript_jquery_ready) %>

        //*** Disqus count ***
        // var disqusPublicKey = "<%= ENV['DISQUS_PUBLIC_KEY'] %>";
        // var disqusShortname = "dontblazy";
        // var threadUrl = 'link:' + $('.showDisqus').attr('data-disqus-url');

        // $.ajax({
        //     type: 'GET',
        //     url: 'https://disqus.com/api/3.0/threads/set.jsonp',
        //     data: { api_key: disqusPublicKey, forum: disqusShortname, thread: threadUrl },
        //     cache: false,
        //     dataType: 'jsonp',
        //     success: function(result) {
        //         if (result.response.length === 1) {
        //             btnText = 'Show Comments (' + result.response[0].posts + ')';
        //             $('.showDisqus').html(btnText);
        //         }
        //     }
        // });


        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'dontbelazy'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/count.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);

    });

    // *** Disqus *** 

      $('.showDisqus').on('click', function(){   // click event of the show comments button
        var this_ = $(this);
            disqus_shortname = 'dontblazy',
            title = $(this).attr('data-title'),
            identifier = parseFloat($(this).attr('data-id')),
            url = $(this).attr('data-url');

        if (window.DISQUS) {
            // if Disqus is already loaded on the page
            
            DISQUS.reset({ // Remove the old call
              reload: false,
              config: function () {
                this.page.identifier = window.old_identifier;
                this.page.url = window.old_url;
                this.page.title = window.old_title;
              }
            });
            $('.showDisqus').show();
            $('#disqus_thread').remove();

            $('<div id="disqus_thread"></div>').insertAfter(this_);

            setTimeout( function() { // Creates a new call DISQUS, with the new ID
                DISQUS.reset({
                  reload: true,
                  config: function () {
                    this.page.identifier = identifier;
                    this.page.url = url;
                    this.page.title = title;
                  }
                });
                window.old_identifier = identifier;
                window.old_url = url;
                window.old_title = title;
            });

        } else {
            // Disqus NOT loaded yet
            var disqus_identifier = parseFloat(identifier),
                disqus_title = title,
                disqus_url = url;

            $('<div id="disqus_thread"></div>').insertAfter(this_);

            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();

            setTimeout( function() { 
                DISQUS.reset({
                  reload: true,
                  config: function () {
                    this.page.identifier = identifier;
                    this.page.url = url;
                    this.page.title = title;
                  }
                });
            },500);

            window.old_identifier = identifier;
            window.old_url = url;
            window.old_title = title;

        }
        $(this).fadeOut();  // remove the show comments button
    });
    </script>
  </body>
</html>
